<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Private Chat</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f2f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }
        
        .user-info h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .status-info {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-top: 0.2rem;
        }
        
        .status-online {
            color: #4ade80;
        }
        
        .status-offline {
            color: #f87171;
        }
        
        .header-actions {
            display: flex;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        
        .btn-danger {
            background: #ef4444;
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        .messages-container {
            flex: 1;
            padding: 1rem;
            overflow-y: auto;
            background: #fafafa;
        }
        
        .message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }
        
        .message.own {
            align-items: flex-end;
        }
        
        .message.other {
            align-items: flex-start;
        }
        
        .message-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 18px;
            word-wrap: break-word;
            position: relative;
        }
        
        .message.own .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .message.other .message-bubble {
            background: #e5e7eb;
            color: #374151;
        }
        
        .message-info {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        
        .message.own .message-info {
            text-align: right;
        }
        
        .message.other .message-info {
            text-align: left;
        }
        
        .input-container {
            padding: 1rem;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            gap: 0.5rem;
        }
        
        .message-input {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            outline: none;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .message-input:focus {
            border-color: #667eea;
        }
        
        .send-btn {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s;
        }
        
        .send-btn:hover {
            transform: translateY(-1px);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .empty-state {
            text-align: center;
            color: #6b7280;
            padding: 2rem;
            font-style: italic;
        }
        
        @media (max-width: 768px) {
            .header {
                padding: 1rem;
            }
            
            .user-info h2 {
                font-size: 1.1rem;
            }
            
            .status-info {
                font-size: 0.8rem;
            }
            
            .header-actions {
                gap: 0.5rem;
            }
            
            .btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.8rem;
            }
            
            .message-bubble {
                max-width: 85%;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <h2 id="otherUserName">Mencari partner chat...</h2>
            <div class="status-info" id="statusInfo">
                <span id="statusText">Offline</span>
                <span id="lastSeenText"></span>
            </div>
        </div>
        <div class="header-actions">
            <button class="btn btn-danger" onclick="clearAllMessages()">Hapus Semua</button>
            <button class="btn btn-secondary" onclick="logout()">Keluar</button>
        </div>
    </div>
    
    <div class="chat-container">
        <div class="messages-container" id="messagesContainer">
            <div class="empty-state" id="emptyState">
                Belum ada pesan. Mulai percakapan!
            </div>
        </div>
        
        <div class="input-container">
            <input type="text" class="message-input" id="messageInput" placeholder="Ketik pesan..." maxlength="500">
            <button class="send-btn" id="sendBtn" onclick="sendMessage()">Kirim</button>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let currentUser = '';
        let otherUser = null;

        // Initialize
        async function init() {
            try {
                const response = await fetch('/api/user');
                const userData = await response.json();
                currentUser = userData.currentUser;
                otherUser = userData.otherUser;
                
                if (otherUser) {
                    document.getElementById('otherUserName').textContent = otherUser.username;
                    updateUserStatus(otherUser.isOnline, otherUser.lastSeen);
                }
                
                socket.emit('join', currentUser);
                loadMessages();
            } catch (error) {
                console.error('Error initializing:', error);
            }
        }

        // Load messages
        async function loadMessages() {
            try {
                const response = await fetch('/api/messages');
                const messages = await response.json();
                displayMessages(messages);
            } catch (error) {
                console.error('Error loading messages:', error);
            }
        }

        // Display messages
        function displayMessages(messages) {
            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');
            
            if (messages.length === 0) {
                emptyState.style.display = 'block';
                return;
            }
            
            emptyState.style.display = 'none';
            container.innerHTML = '';
            
            messages.forEach(message => {
                const messageEl = createMessageElement(message);
                container.appendChild(messageEl);
            });
            
            scrollToBottom();
        }

        // Create message element
        function createMessageElement(message) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${message.sender === currentUser ? 'own' : 'other'}`;
            
            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.textContent = message.text;
            
            const info = document.createElement('div');
            info.className = 'message-info';
            info.textContent = formatTime(message.timestamp);
            
            messageDiv.appendChild(bubble);
            messageDiv.appendChild(info);
            
            return messageDiv;
        }

        // Format time
        function formatTime(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Baru saja';
            if (diffMins < 60) return `${diffMins} menit lalu`;
            if (diffHours < 24) return `${diffHours} jam lalu`;
            if (diffDays < 7) return `${diffDays} hari lalu`;
            
            return date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short',
                year: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined
            }) + ' ' + date.toLocaleTimeString('id-ID', {
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Format last seen time
        function formatLastSeen(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Terakhir aktif baru saja';
            if (diffMins < 60) return `Terakhir aktif ${diffMins} menit lalu`;
            if (diffHours < 24) return `Terakhir aktif ${diffHours} jam lalu`;
            if (diffDays < 7) return `Terakhir aktif ${diffDays} hari lalu`;
            
            return 'Terakhir aktif ' + date.toLocaleDateString('id-ID', {
                day: 'numeric',
                month: 'short'
            });
        }

        // Update user status
        function updateUserStatus(isOnline, lastSeen) {
            const statusText = document.getElementById('statusText');
            const lastSeenText = document.getElementById('lastSeenText');
            
            if (isOnline) {
                statusText.textContent = 'Online';
                statusText.className = 'status-online';
                lastSeenText.textContent = '';
            } else {
                statusText.textContent = 'Offline';
                statusText.className = 'status-offline';
                lastSeenText.textContent = ' • ' + formatLastSeen(lastSeen);
            }
        }

        // Send message
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            socket.emit('sendMessage', {
                sender: currentUser,
                text: text
            });
            
            input.value = '';
        }

        // Clear all messages
        async function clearAllMessages() {
            if (!confirm('Yakin ingin menghapus semua pesan? Tindakan ini tidak dapat dibatalkan.')) {
                return;
            }
            
            try {
                const response = await fetch('/api/messages', {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    const container = document.getElementById('messagesContainer');
                    const emptyState = document.getElementById('emptyState');
                    container.innerHTML = '';
                    emptyState.style.display = 'block';
                    
                    // Notify other user
                    socket.emit('messagesCleared');
                }
            } catch (error) {
                console.error('Error clearing messages:', error);
                alert('Terjadi kesalahan saat menghapus pesan');
            }
        }

        // Logout
        async function logout() {
            try {
                await fetch('/api/logout', { method: 'POST' });
                window.location.href = '/login';
            } catch (error) {
                console.error('Error logging out:', error);
                window.location.href = '/login';
            }
        }

        // Scroll to bottom
        function scrollToBottom() {
            const container = document.getElementById('messagesContainer');
            container.scrollTop = container.scrollHeight;
        }

        // Socket event listeners
        socket.on('newMessage', (message) => {
            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');
            
            emptyState.style.display = 'none';
            
            const messageEl = createMessageElement(message);
            container.appendChild(messageEl);
            scrollToBottom();
        });

        socket.on('userStatusChanged', (data) => {
            if (otherUser && data.username === otherUser.username) {
                updateUserStatus(data.isOnline, data.lastSeen);
            }
        });

        socket.on('messagesCleared', () => {
            const container = document.getElementById('messagesContainer');
            const emptyState = document.getElementById('emptyState');
            container.innerHTML = '';
            emptyState.style.display = 'block';
        });

        // Event listeners
        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Update last seen time periodically
        setInterval(() => {
            if (otherUser && !otherUser.isOnline) {
                updateUserStatus(false, otherUser.lastSeen);
            }
        }, 60000); // Update every minute

        // Initialize app
        init();
    </script>
</body>
</html>
